# Railway / Nixpacks build configuration
#
# The root package.json (Node.js TS worker) and requirements.txt (Python scraper)
# both exist. Nixpacks would auto-switch to Node.js-only mode and drop Python,
# making `pip` unavailable. We explicitly add Python 3.11 + pip back.
#
# PIP_BREAK_SYSTEM_PACKAGES=1 is required because Nix marks its Python as
# "externally managed" (PEP 668), which blocks pip install into the Nix store.
# Setting this env var bypasses the restriction for all pip calls (including
# the ones Nixpacks auto-generates in the build phase).

[variables]
PIP_BREAK_SYSTEM_PACKAGES = "1"

[phases.setup]
nixPkgs = ['python311', 'python311Packages.pip']
aptPkgs = [
  "libglib2.0-0",
  "libnss3",
  "libnspr4",
  "libatk1.0-0",
  "libatk-bridge2.0-0",
  "libcups2",
  "libdrm2",
  "libdbus-1-3",
  "libxkbcommon0",
  "libatspi2.0-0",
  "libxcomposite1",
  "libxdamage1",
  "libxfixes3",
  "libxrandr2",
  "libgbm1",
  "libxshmfence1",
  "libasound2t64",
  "libpangocairo-1.0-0",
  "libpango-1.0-0",
  "libcairo2",
  "libgtk-3-0",
  "ca-certificates",
  "fonts-liberation"
]

[phases.install]
cmds = [
  'pip install --no-cache-dir -r requirements.txt',
  'npm install',
]

[phases.build]
cmds = ['python -m playwright install chromium']

[start]
cmd = 'gunicorn scraper_api:app --bind 0.0.0.0:$PORT --timeout 300 --workers 1'
